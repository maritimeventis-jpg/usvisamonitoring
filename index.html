<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="robots" content="noindex">
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Fleet Visa Master Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0; margin: 0; }
            .print-break { page-break-after: always; }
            .fleet-card { page-break-inside: avoid; border: 1px solid #eee; }
            table { font-size: 8px !important; }
        }
        .tab-btn { border-bottom: 4px solid transparent; transition: 0.3s; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 800; }
        .sticky-nav { position: sticky; top: 0; z-index: 50; background: white; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <header class="bg-slate-900 text-white p-4 no-print shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black tracking-tighter italic">FLEET VISA TRACKER 2026</h1>
            <div class="flex items-center gap-4">
                <span id="syncStatus" class="text-[10px] bg-amber-500/20 text-amber-400 px-2 py-1 rounded border border-amber-500/30 font-bold uppercase">Connecting to Master Sheet...</span>
            </div>
        </div>
    </header>

    <nav class="sticky-nav border-b no-print shadow-sm">
        <div class="container mx-auto px-4 flex space-x-6 overflow-x-auto scrollbar-hide">
            <button onclick="switchTab('monitoring')" id="t-monitoring" class="tab-btn py-4 active text-xs font-bold uppercase">Monitoring</button>
            <button onclick="switchTab('released')" id="t-released" class="tab-btn py-4 text-slate-400 text-xs font-bold uppercase">Released</button>
            <button onclick="switchTab('applied')" id="t-applied" class="tab-btn py-4 text-slate-400 text-xs font-bold uppercase">Applied</button>
            <button onclick="switchTab('pending')" id="t-pending" class="tab-btn py-4 text-slate-400 text-xs font-bold uppercase">Pending</button>
            <button onclick="switchTab('onhold')" id="t-onhold" class="tab-btn py-4 text-slate-400 text-xs font-bold uppercase">On-Hold</button>
            <button onclick="switchTab('canceled')" id="t-canceled" class="tab-btn py-4 text-slate-400 text-xs font-bold uppercase">Canceled</button>
            <button onclick="switchTab('rejected')" id="t-rejected" class="tab-btn py-4 text-slate-400 text-xs font-bold uppercase">Rejected</button>
            <button onclick="switchTab('overview')" id="t-overview" class="tab-btn py-4 text-blue-600 font-black text-xs uppercase">Overview</button>
        </div>
    </nav>

    <div class="container mx-auto p-4 lg:p-8">
        <div class="mb-6 flex flex-col md:flex-row gap-4 items-center justify-between no-print">
            <div id="filterControls" class="flex flex-1 gap-4 w-full">
                <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Search Name, Username or Code..." class="flex-1 p-3 rounded-xl border bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
                <select id="fleetFilter" onchange="renderTable()" class="p-3 rounded-xl border bg-white shadow-sm font-bold text-sm min-w-[150px]">
                    <option value="">All Fleets</option>
                    <option value="OSS">OSS</option>
                    <option value="KRBS/PCC">KRBS/PCC</option>
                    <option value="KRBS/BULK">KRBS/BULK</option>
                    <option value="TANKER">TANKER</option>
                    <option value="PRS">PRS</option>
                </select>
            </div>
            <button onclick="window.print()" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold text-xs flex items-center gap-2 hover:bg-slate-800 transition">
                PRINT CURRENT VIEW
            </button>
        </div>

        <div id="tableView" class="bg-white rounded-2xl shadow-xl overflow-x-auto border">
            <table class="w-full text-left text-xs border-collapse">
                <thead id="tableHead" class="bg-slate-100 text-slate-500 font-black uppercase border-b"></thead>
                <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <div id="overviewSection" class="hidden">
            <div class="bg-white p-8 rounded-3xl shadow-sm border mb-8">
                <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-8">Global Status Distribution</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 items-center">
                    <div class="flex justify-center">
                        <div style="width: 260px; height: 260px;"><canvas id="mainDonutChart"></canvas></div>
                    </div>
                    <div id="globalStatsGrid" class="lg:col-span-2 grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
                </div>
            </div>
            <h2 class="text-xl font-black text-slate-900 mb-6 flex items-center gap-2">
                <span class="w-2 h-8 bg-blue-600 rounded-full"></span> Fleet Performance Breakdown
            </h2>
            <div id="fleetComparisonGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>

    <script>
        // STEP 2: PASTE YOUR CSV LINK HERE
        const sheetUrl = 'PASTE_YOUR_CSV_LINK_HERE';

        let DATA = {
            global: { RELEASED: 0, APPLIED: 0, PENDING: 0, ONHOLD: 0, CANCEL: 0, REJECTED: 0 },
            fleets: {},
            records: []
        };

        let activeTab = 'monitoring';
        let activeCharts = [];

        function initSync() {
            Papa.parse(sheetUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    processSheetData(results.data);
                    document.getElementById('syncStatus').innerText = "Database Synchronized";
                    document.getElementById('syncStatus').className = "text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded border border-emerald-500/30 font-bold uppercase";
                    switchTab('monitoring'); 
                },
                error: function(err) {
                    document.getElementById('syncStatus').innerText = "Sync Failed";
                    console.error("CSV Error:", err);
                }
            });
        }

        function processSheetData(rawRows) {
            DATA.records = [];
            DATA.global = { RELEASED: 0, APPLIED: 0, PENDING: 0, ONHOLD: 0, CANCEL: 0, REJECTED: 0 };
            DATA.fleets = {};

            rawRows.forEach(row => {
                if (!row.NAME && !row.FLEET) return;

                const record = {
                    f: row.FLEET || "N/A",
                    s: (row.STATUS || "PENDING").toUpperCase(),
                    n: row.NAME || "UNKNOWN",
                    u: row.USERNAME || "",
                    p: row.PASSWORD || "",
                    s1: row.MID_NAME || "",
                    s2: row.BIRTH_CITY || "",
                    s3: row.DFA || "",
                    c: row.APP_CODE || ""
                };

                DATA.records.push(record);

                // Handle Status Keys for Stats
                let sKey = record.s;
                if (sKey === 'HOLD' || sKey === 'ON-HOLD') sKey = 'ONHOLD';
                if (sKey === 'CANCELED' || sKey === 'CANCELLED') sKey = 'CANCEL';
                
                // Increment Global
                if (DATA.global.hasOwnProperty(sKey)) DATA.global[sKey]++;

                // Increment Fleet
                if (!DATA.fleets[record.f]) {
                    DATA.fleets[record.f] = { RELEASED: 0, APPLIED: 0, PENDING: 0, ONHOLD: 0, CANCEL: 0, REJECTED: 0 };
                }
                if (DATA.fleets[record.f].hasOwnProperty(sKey)) DATA.fleets[record.f][sKey]++;
            });
        }

        function switchTab(id) {
            activeTab = id;
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'text-blue-600');
                b.classList.add('text-slate-400');
            });
            const btn = document.getElementById('t-' + id);
            if(btn) {
                btn.classList.add('active');
                btn.classList.remove('text-slate-400');
                if(id === 'overview') btn.classList.add('text-blue-600');
            }

            const isOv = (id === 'overview');
            document.getElementById('tableView').style.display = isOv ? 'none' : 'block';
            document.getElementById('overviewSection').style.display = isOv ? 'block' : 'none';
            document.getElementById('filterControls').style.opacity = isOv ? '0' : '1';

            if (isOv) renderOverview(); else renderTable();
        }

        function renderTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const fleetSel = document.getElementById('fleetFilter').value;
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');

            let cols = (activeTab === 'monitoring') 
                ? ["FLEET", "STATUS", "NAME", "USERNAME", "PASSWORD", "SEC1", "SEC 2", "SEC 3", "APP CODE"]
                : ["FLEET", "NAME", "USERNAME", "STATUS", "APP CODE"];

            head.innerHTML = `<tr>${cols.map(c => `<th class="p-4">${c}</th>`).join('')}</tr>`;

            const filtered = DATA.records.filter(r => {
                const matchesFleet = !fleetSel || r.f === fleetSel;
                const matchesSearch = r.n.toLowerCase().includes(query) || r.u.toLowerCase().includes(query) || r.c.toLowerCase().includes(query);
                let matchesStatus = true;
                if (activeTab !== 'monitoring') {
                    const map = { released: 'RELEASED', applied: 'APPLIED', pending: 'PENDING', onhold: 'HOLD', canceled: 'CANCEL', rejected: 'REJECTED' };
                    matchesStatus = r.s.includes(map[activeTab]);
                }
                return matchesFleet && matchesSearch && matchesStatus;
            });

            body.innerHTML = filtered.map(r => {
                const cells = (activeTab === 'monitoring') ? [r.f, r.s, r.n, r.u, r.p, r.s1, r.s2, r.s3, r.c] : [r.f, r.n, r.u, r.s, r.c];
                return `<tr class="hover:bg-slate-50 transition">${cells.map((cell, i) => `<td class="p-4 ${i===0?'font-black text-slate-900':''} ${cell===r.c && cell!==''?'font-mono font-bold text-blue-600':''}">${cell}</td>`).join('')}</tr>`;
            }).join('');
        }

        function renderOverview() {
            activeCharts.forEach(c => c.destroy());
            activeCharts = [];

            const colors = { RELEASED: 'text-emerald-600', APPLIED: 'text-blue-600', PENDING: 'text-orange-500', ONHOLD: 'text-slate-500', CANCEL: 'text-red-600', REJECTED: 'text-rose-900' };
            
            document.getElementById('globalStatsGrid').innerHTML = Object.entries(DATA.global).map(([k,v]) => `
                <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100 text-center">
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">${k}</p>
                    <p class="text-3xl font-black ${colors[k]}">${v}</p>
                </div>`).join('');

            const ctxDonut = document.getElementById('mainDonutChart').getContext('2d');
            activeCharts.push(new Chart(ctxDonut, {
                type: 'doughnut',
                data: { labels: Object.keys(DATA.global), datasets: [{ data: Object.values(DATA.global), backgroundColor: ['#10b981','#3b82f6','#f59e0b','#64748b','#ef4444','#9f1239'], borderWidth: 0 }] },
                options: { cutout: '85%', plugins: { legend: { display: false } } }
            }));

            document.getElementById('fleetComparisonGrid').innerHTML = Object.entries(DATA.fleets).map(([name, stats], i) => `
                <div class="bg-white p-6 rounded-3xl border shadow-sm fleet-card">
                    <div class="flex justify-between items-start mb-6">
                        <div><p class="text-[10px] font-black text-slate-400 uppercase">Fleet Unit</p><h3 class="text-lg font-black text-slate-800">${name}</h3></div>
                        <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black">${Object.values(stats).reduce((a,b)=>a+b, 0)} TOTAL</span>
                    </div>
                    <div style="height: 200px;"><canvas id="bar-${i}"></canvas></div>
                </div>`).join('');

            Object.entries(DATA.fleets).forEach(([name, stats], i) => {
                const ctx = document.getElementById(`bar-${i}`).getContext('2d');
                activeCharts.push(new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['REL', 'APP', 'PEN', 'HLD', 'CAN', 'REJ'], datasets: [{ data: [stats.RELEASED, stats.APPLIED, stats.PENDING, stats.ONHOLD, stats.CANCEL, stats.REJECTED], backgroundColor: ['#10b981','#3b82f6','#f59e0b','#64748b','#ef4444','#9f1239'], borderRadius: 6, barThickness: 15 }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
                }));
            });
        }

        window.onload = initSync;
    </script>
</body>
</html>
